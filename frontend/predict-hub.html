<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Predict Hub</title>
    <style>
body { font-family: arial, sans-serif; padding: 30px; font-size: 14pt; }
textarea { width: 500px; height: 150px; font-size: 14pt; }
button { font-size: 14pt; cursor: pointer; }
span { cursor: pointer; opacity: 0.8; }
#examples { display: none; }
input[type="range"] { width: 300px; cursor: pointer; }
    </style>
  </head>
  <body>
    <strong>Model ID</strong>:
    <div id="model_id"></div>
    <strong>Content</strong>
    <br/>
    <textarea id="content" placeholder="Paste in a Tweet for analysis" dir="auto"></textarea>
    <br/><br/>
    <button id="submit">Predict</button>
    <br/>
    <hr/>
    <h4 id="prediction"></h4>
    <div id="highlight" dir="auto">
    </div>
    <div id="examples">
      <input id="range" type="range" min="-1" max="1" step="0.05" onChange="updateRange(event)"/>
      <input id="range2" type="text" onChange="updateRange(event)" onInput="updateRange(event)"/>
      <br/>
      <table id="rows" border="1">
      </table>
      <button id="saveAll">Save All Changes</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script>
let modelID,
  finalScore = 0,
  startScore,
  selectSpan,
  explain = { neg: 'Negative', pos: 'Positive' },
  changes = {};

function updateRange(e) {
  let value = e.target.value * 1;
  $('#range').val(value);
  $('#range2').val(value);

  changes[selectSpan.text()] = value;

  let color = (value < 0) ? 0 : 100;
  let percent = Math.round((1 - Math.abs(value)) * 100);
  percent = Math.max(20, percent);
  selectSpan.css({
    background: 'hsl(' + color + ', 100.00%, ' + percent + '.00%)'
  });

  let resultScore = finalScore - startScore + value
  let prediction = (resultScore > 0) ? 'pos' : 'neg';
  $('#prediction').text(explain[prediction] + ' (' + resultScore.toFixed(3) + ')');
}
function parseResponse(data) {
  let focus = 0;
  let content = 'ุฅุฐุง ูุฒุงุฌู ุชููู ุงูุดูุฑ ุจููู ุฅูุฏ ูุฑุนุจ ๐ป - Clown ููุงุน ุนูุฏ ูููุงุฏ ููุฏูุ ูุตูุฑ ูุนูุฉ ๐คก - The conjuring 2 ุฑูุญ ุดุฑูุฑุฉ ุชุณุชุญูุฐ ุนูู ุจูุช ๐ฑ - The mist ูุงุฆู ูุฑุนุจ ูุฎุชูู ูุฑุงุก ุงูุถุจุงุจ ๐ถ - Slasher ูุงุชู ูุชุณูุณู ููุฏุฏ ุญูุงุฉ ุงููุงุณ ๐จ  - OCULUS ุฃุฎูุงุช ูุญุงูููุง ุงูุชุบูุจ ุนูู ุตุฏูุฉ ููุงุฉ ูุงูุฏููู';
  let prediction = data.predictions[0];
  let explanation = data.explanations[0];

  function colorWord(word, score) {
    if (word.toLowerCase() === 'the') {
      return;
    }
    let color = (score < 0) ? 0 : 100;
    let percent = Math.round((1 - Math.abs(score)) * 100);
    percent = Math.max(20, percent);
    let rg = new RegExp('\\s' + word + '\\s', 'ig');
    content = content.replace(rg, ' <span style="background: hsl(' + color + ', 100.00%, ' + percent + '.00%)">' + word + '</span> ')
  }
  // we are making a big assumption here that every word appears once
  let associatedScore = {};

  explanation.neg.forEach((factor) => {
    let word = factor[0],
        score = factor[1] * (prediction === 'neg' ? -1 : 1);
    finalScore += score;
    associatedScore[word] = score;
    colorWord(word, score);
  });
  explanation.pos.forEach((factor) => {
    let word = factor[0],
        score = factor[1] * (prediction === 'pos' ? 1 : -1);
    finalScore += score;
    associatedScore[word] = score;
    colorWord(word, score);
  });
  $('#highlight').html(content);

  $('#prediction').text(explain[prediction] + '(' + finalScore.toFixed(3) + ')');

  $('span').click((e) => {
    selectSpan = $(e.target);
    let interest = selectSpan.text();
    startScore = associatedScore[interest] || 0;
    $('#range').val(startScore);
    $('#range2').val(startScore.toFixed(3));
    fetch("/training_data/find_word/" + modelID, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: interest })
    }).then(res => res.json())
      .then((data) => {
        $('#rows').html('');
        $('#examples').show();
        data.forEach((sample) => {
          let col = $('<td>').text(sample);
          $('#rows').append($('<tr>').append(col));
        });
      });
  });
}
$(document).ready(function() {
  let urlSections = window.location.href.split("?")[0].split("/");
  modelID = urlSections[urlSections.length - 1];
  $("#model_id").text(modelID);
  $("#submit").click((e) => {
    if (window.location.href.indexOf('demo') > -1) {
      parseResponse({"explanations":[{"neg":[["ุนูุฏ ูููุงุฏ",-0.6940852000541679],["ุงูุดูุฑ ุจููู",-0.4954969066220406],["ูุตูุฑ ูุนูุฉ",-0.49277259781888577],["ุดุฑูุฑุฉ ุชุณุชุญูุฐ",-0.48683976879602653],["ูุฒุงุฌู ุชููู",-0.384807600480993],["mist ูุงุฆู",-0.3790515232954936],["ุงููุงุณ oculus",-0.3751471871302195],["ุงูุถุจุงุจ slasher",-0.34951961990429353],["2 ุฑูุญ",-0.33784721062235823],["ูุฑุนุจ ูุฎุชูู",-0.32025052162405315],["ุนูู ุจูุช",-0.31564487105929545],["ุจูุช the",-0.28399895056232316],["ุชููู ุงูุดูุฑ",-0.27054977504226535],["ุนูู ุตุฏูุฉ",-0.2699559544708061],["conjuring 2",-0.2686379809347582],["ุฅุฐุง ูุฒุงุฌู",-0.2551900825075719],["ูุงุชู ูุชุณูุณู",-0.2508746094902172],["ููุฏู ูุตูุฑ",-0.24931153733066327],["ุงูุชุบูุจ ุนูู",-0.24529652995497053],["ูููุงุฏ ููุฏู",-0.2236590297248564],["slasher ูุงุชู",-0.21134180284794518],["ุฑูุญ ุดุฑูุฑุฉ",-0.20486523294807285],["ุฃุฎูุงุช ูุญุงูููุง",-0.19050721910503932],["ูุนูุฉ the",-0.1884444628049328],["oculus ุฃุฎูุงุช",-0.15472954217075516],["the conjuring",-0.1321803662288124],["the mist",-0.12542884872944787],["ูุญุงูููุง ุงูุชุบูุจ",-0.08548348835133844],["ููุงุฉ ูุงูุฏููู",-0.0449786879081942],["ุฅูุฏ ูุฑุนุจ",-0.04402449598729097],["ุฅูุฏ",-0.038061061959786834],["ูุงูุฏููู",-0.03098098940759666]],"pos":[["ุนูู",0.9370304045395483],["ุจูุช",0.8524395565461222],["the",0.7061402889550176],["ูุฑุนุจ",0.6114120414037911],["oculus",0.5564459465628202],["2",0.5508623879438166],["ูุนูุฉ",0.5069716920596862],["ูุงุฆู",0.48735714756428405],["mist",0.48550034288773997],["ุจููู",0.43479833481345814],["ุชููู",0.4315170498808087],["ุฃุฎูุงุช",0.4239921285141017],["<BIAS>",0.40811164012893136],["ุฑูุญ",0.4074434968139599],["slasher",0.3843826422987915],["ูููุงุฏ",0.3821805907565017],["ุญูุงุฉ ุงููุงุณ",0.3615461306014319],["ุชุณุชุญูุฐ",0.33003011821990097],["ููุงุน",0.31980017510023917],["ููุฏุฏ",0.3194537339666123],["ุงูุดูุฑ",0.28522106419414234],["ุดุฑูุฑุฉ",0.2626930876701342],["ูุฒุงุฌู",0.2567737565227665],["ุงูุชุบูุจ",0.245297468067684],["ูุชุณูุณู",0.22444306575033784],["ุงูุถุจุงุจ",0.21378719775375832],["ูุญุงูููุง",0.20755649886678482],["conjuring",0.20037810410605897],["ููุฏู",0.17587587170366767],["ูุฑุงุก",0.13265836457365293],["ุนูุฏ",0.12948055275986842],["ุตุฏูุฉ ููุงุฉ",0.1246968519923606],["ููุงุฉ",0.10982130675467999],["ูุฎุชูู",0.10492146040130149],["ูุชุณูุณู ููุฏุฏ",0.017915029307582594]]},{"neg":[["ุญ ุจ",-0.7496232010664717],["ุงุฌูุงุฆู ููุณ",-0.652950823866346],["ุดู ูุญูุณ",-0.583656552087594],["cable girls",-0.5737953448652945],["ูุงุฌูุงู ููุจู",-0.5344596416187813],["ูุญุฑุจ ููุฐุง",-0.5225260194412039],["ุงุจุบู ูุณูุณู",-0.4842111571557777],["ููุฐุง ูุงุฌูุงู",-0.4043305318943833],["ูุญูุณ ููุจุณุท",-0.4030488225939663],["ูุฑุงูุด ุญ",-0.3877260076569652],["girls ู",-0.26099471150030457],["ููุจุณุท ูุนูู",-0.2415618538338229],["ููุจู ุดู",-0.17929384993088898],["ู ูุฑุงูุด",-0.1477648271221028],["ูุณูุณู ุงุฌูุงุฆู",-0.1165157848276607],["ููุณ cable",-0.0825976718931908]],"pos":[["ููุณ",0.7641315569247876],["ููุฐุง",0.7626380319887376],["ูุฑุงูุด",0.7257515951784831],["ู",0.6978883214722061],["ููุจุณุท",0.6868290388659581],["<BIAS>",0.6759819852294511],["ูุญูุณ",0.5735955392970269],["ูุณูุณู",0.5261322305626116],["ูุญุฑุจ",0.5248307464756037],["cable",0.5204062136273068],["ููุจู",0.47270043869633344],["ูุงุฌูุงู",0.4221097242221998],["ุดู",0.42136798531073777],["ุจ",0.4107755965071308],["ุญ",0.39497243147172123],["ุงุจุบู",0.34866643715593904],["girls",0.1921067311144491],["ุงุฌูุงุฆู",0.18965490544887956],["ูุนูู",0.16358917980451954]]}],"predictions":["neg","neg"]});
    } else {
      fetch("/predict/" + modelID, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: $('#content').val() })
      }).then(res => res.json())
        .then((data) => {
          parseResponse(data);
        });
    }
  });

  $('#saveAll').click(() => {
    if (Object.keys(changes).length) {
      fetch("/training_data/adjust/" + modelID, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ words: changes })
      }).then(res => res.json())
        .then((response) => {
          alert("Success!");
        });
    }
  });
});
    </script>
  </body>
</html>
